<link rel="import" href="../paper-button/paper-button.html">
<dom-module id='paper-filter'>
  <style>
    :host {
      display: block;
      overflow: hidden;
    }
    :host paper-button {
      background: #fff;
      width: 150px;
      max-width: 45%;
      margin: 0px 5px 7px;
    }
    :host paper-button {
      background: var(--accent-color);
      color: #000;
    }
    :host paper-button[raised] {
      background: #fff !important;
      color: var(--accent-color);
    }
    :host div+div paper-button {
      font-size: .9em;
      min-width:106px;
    }
    .mini-badge {
      display: inline-block;
      min-width: 10px;
      padding: 3px 7px;
      color: #FFF;
      vertical-align: baseline;
      background-color: #6F6F6F;
      border-radius: 10px;
    }
  </style>
  <template>
    <template is="dom-repeat" items="{{filters}}">
      <div index="{{index}}">
        <template is="dom-repeat" items="{{item}}" class="filter">
          <paper-button raised="{{!item.filtered}}" on-tap="setFilter" data-max="{{item.max}}" title="{{item.name}}">
            <span>{{item.name}}</span>
            <template is="dom-if" if="{{showNumbers}}">
              <span class="mini-badge">{{item.num}}</span>
            </template>
          </paper-button>
        </template>
      </div>
    </template>
  </template>
</dom-module>
<script>
(function() {
  function hasTypes (data,types) {
    for (var key in types) {
      if (types.hasOwnProperty(key)) {
        var obj = types[key];
        for (var prop in obj) {
          if(obj.hasOwnProperty(prop)){
            if (data.hasOwnProperty(key)) {
              if (obj[prop]) {
                if (data[key].indexOf(prop) === -1 ) {
                  return false;
                }
              } else {
                if (data[key].indexOf(prop) !== -1 ) {
                  return false;
                }
              }
            } else {
              return false;
            }
          }
        }
      }
    }
    return true;
  }
  function isEmpty(obj) {
    for(var prop in obj) {
      if(obj.hasOwnProperty(prop)) {
        return false;
      }
    }
    return true;
  }
  Polymer({
    is: 'paper-filter',
    properties:{
      filters:{
        computed: 'getFilters(data, byArray, obj_filters, min, other)'
      },
      top_filter:{
        type: Array,
        notify: true,
        computed: 'justProperties(data, byArray[0], 0, 0, obj_filters, byArray)'
      },
      obj_filters:{
        type: Object,
        notify: true,
        value: {}
      },
      /* by The comma separated value */
      by:String,
      byArray: {
        computed: 'getByArray(by)'
      },
      other: {
        type: String, value: "Other"
      },
      min: {
        type: Number, value: 1 
      },
      output: {
        notify: true,
        computed: 'justOfTypes(data,obj_filters)'
      },
      data:Array//,
//      dataGrid:{
//        type:Object,
//        computed: 'getDataGrid(data,byArray)'
//      },
    },
/*    getDataGrid: function(data,byArray) {// not used for later if speed is needed
      var obj_filter = {};
      for (var i = 0,l = byArray.length; i < l; i++) {
        var by = byArray[i];
        var list = [];
        var filters = this.getFilters(data,byArray,{});
        obj_filter[by] = {};
       // debugger;
        for (var i_2 = 0,l_2 = filters.length; i_2 < l_2; i_2++) {
          var filter = filters[i_2];
          for (var i_3 = 0,l_3 = filter.length; i_3 < l_3; i_3++) {
            obj_filter = this._setFilter(filters[i_2][i_3].name, i, by, filters[i_2][i_3].max, obj_filter);
            comb = this.justOfTypes(data, obj_filter);
            if (comb.length > 0) {
              list.push(comb);
            }
          }
        }
        for (var i_2 = 0,l_2 = list.length; i_2 < l; i_2++) {
          //make data grid
          debugger;
          console.log(list[i_2]);
        }
      }
    },*/
/**
 * turns to comma separated value into an array.
 *
 * @param {String} by The comma separated value
 * @return {Array} of {String} what is to be filtered by.
 */
    getByArray: function(by) {
      return by.split(',');
    },
    justProperties: function(data, properties, numberPressed, index, obj_filters, byArray) {
      if (obj_filters.hasOwnProperty('base') && obj_filters.hasOwnProperty('path') && obj_filters.hasOwnProperty('value')) {
        obj_filters = obj_filters.value;
      }
      var output = [];
      var outputNum = [];
      var max = 0;
      if (data !== undefined && data !== null && Array.isArray(data) && data.length > 1) {// garding
        var _obj_filters = {};
        //TODO perform the filters that come before needs work
        for (var i = 0; i < index; i++) {
          if (obj_filters.hasOwnProperty(byArray[i])) {
            _obj_filters[byArray[i]] = obj_filters[byArray[i]];
          }
        }
        data = this.justOfTypes(data, _obj_filters);// TODO if all are in a filter set it as true
        var test = function(entryA) {
          if (output.indexOf(entryA) === -1) {
            output.push(entryA);
            outputNum.push(1);
          } else {
            outputNum[output.indexOf(entryA)]++;
          }
        };
        for (var i = 0, l = data.length; i < l; i++) {
          if (data[i][properties] === undefined) continue;
          if (Array.isArray(data[i][properties])) {
            for (var b = 0, c = data[i][properties].length; b < c; b++) {
              test(data[i][properties][b]);
            }
            if (max < c) { max = c; }
          } else {
            test(data[i][properties]);
            max = 1
          }
        }
      }
      var result = [];
      for (var a = 0, x = output.length; a < x; a++) {
        result[a] = {
          name: output[a],
          num: outputNum[a],
          filtered: this.ifFiltered(output[a], properties, numberPressed),
          max: max
        };
      }
      function closistTo(numb) {
        return function(a, b) {
          return ((numb-a.num)^2) - ((numb-b.num)^2);
        }
      }
      result.sort(closistTo(output.length/2));
      return result;
    },
    ifFiltered: function(name, properties, numberPressed) {
      if (numberPressed == 0) {
        return false;
      }
      if (this.obj_filters.hasOwnProperty(properties)) {
        if (this.obj_filters[properties].hasOwnProperty(name)) {
          return this.obj_filters[properties][name];
        } else {
          return false;
        }
      } else {
        return false;
      }
    },
    justOfTypes: function(data, obj_filters){
      if (obj_filters.hasOwnProperty('base') && obj_filters.hasOwnProperty('path') && obj_filters.hasOwnProperty('value')) {
        obj_filters = obj_filters.value;
      }
      var totalPressed = 0;
      for (by in obj_filters) {
        totalPressed = totalPressed + Object.keys(obj_filters[by]).length;
      }
      if (data === null || data === undefined) {
        return [];
      }
      if (totalPressed === 0) return data
      if (obj_filters === undefined || isEmpty(obj_filters)) { // no filtering needed
        return data;
      } else {
        var output = [];
        for (var entry = 0, l = data.length; entry < l; entry++) {
          if (hasTypes(data[entry],obj_filters)) { // This is the filter
            output.push(data[entry]);
          }
        };
        return output;
      }
    },
    setFilter: function(e) {
      var title = e.currentTarget.getAttribute('title')
      var index = +e.currentTarget.parentElement.index
      var by = this.byArray[index]
      var max = +e.currentTarget.dataMax
      var obj_filters = this._setFilter(title, index, by, max, this.obj_filters) // TODO set level to redo 
      this.obj_filters = clone(obj_filters); // TODO why clone
    },
    _setFilter: function(title, index, by, max, obj_filters) {
      var numberPressed = 0;
      if (obj_filters.hasOwnProperty(by)) {
        var numberPressed = Object.keys(obj_filters[by]).length;
      }
      if (obj_filters.hasOwnProperty(by)) {
        if (obj_filters[by].hasOwnProperty(title)) {
          delete obj_filters[by][title];
          if (isEmpty(obj_filters[by])) {
            delete obj_filters[by];
          }
        } else {
          if (max === numberPressed) {
            obj_filters[by] = {};
          }
          obj_filters[by][title] = true;
        }
      } else {
        if (obj_filters === undefined) {
          obj_filters = {};
        }
        obj_filters[by] = {};
        obj_filters[by][title] = true;
      }
      return obj_filters;
    },
    getFilters: function (data, byArray, obj_filters, min, other) {
      if (obj_filters.hasOwnProperty('base') && obj_filters.hasOwnProperty('path') && obj_filters.hasOwnProperty('value')) {
        obj_filters = obj_filters.value
      }
      var output = []
      var numberPressed = []

      for (var i = 0,l = byArray.length; i < l; i++) {
        var filter = this.justProperties(data, byArray[i], numberPressed[i], i, obj_filters, byArray)
        output.push(filter)
      }
      //TODO clear not showing filters
      if (min > 1) {
        var otherArray = []
        for (var f = 0,l = output.length; f < l; f++) {
          for (var o = 0,l = output[f].length; o < l; o++) {
            if (output[f][o] && output[f][o].hasOwnProperty('num') && output[f][o].num < min) {
              otherArray.push(output[f][o]) 
              output[f].splice(o, 1)
              o=o-1
            }
          }
          if (otherArray.length > 1) {
            var total = 0
            for (var oi = 0,l = otherArray[f].length; oi < l; oi++) {
              total = otherArray[f][oi].num + total
            }
            // output[f].push({name: other, num: total, otherArray: otherArray})
          }
        }
      }
      // this.render()
      return output
    },
    render: function (o) {
      var f = document.querySelectorAll('template.filter');
      for (var i = 0, l = f.length; i < l; i++) {
        f[i].render();
      };
    }
  });
  function clone(obj) {
    var copy;

    // Handle the 3 simple types, and null or undefined
    if (null == obj || "object" != typeof obj) return obj;

    // Handle Date
    if (obj instanceof Date) {
      copy = new Date();
      copy.setTime(obj.getTime());
      return copy;
    }

    // Handle Array
    if (obj instanceof Array) {
      copy = [];
      for (var i = 0, len = obj.length; i < len; i++) {
        copy[i] = clone(obj[i]);
      }
      return copy;
    }

    // Handle Object
    if (obj instanceof Object) {
      copy = {};
      for (var attr in obj) {
        if (obj.hasOwnProperty(attr)) copy[attr] = clone(obj[attr]);
      }
      return copy;
    }

    throw new Error("Unable to copy obj! Its type isn't supported.");
  }
})();
</script>
