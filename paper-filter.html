<link rel="import" href="../paper-button/paper-button.html">

<dom-module id='paper-filter'> 
  <style>
    :host {
      max-height: 142px;
      display: block;
      overflow: hidden;
    }
    paper-button {
      background: #fff;
      min-width: 172px;
      margin: 0px 2px 6px;
    }
    paper-button {
      background: var(--accent-color);
    }
    paper-button[raised] {
      background: #fff !important;
    }
    :host div+div paper-button {
      font-size: .9em;
      min-width:106px;
    }
    .mini-badge {
      display: inline-block;
      min-width: 10px;
      padding: 3px 7px;
      color: #FFF;
      vertical-align: baseline;   
      background-color: #6F6F6F;
      border-radius: 10px;
    }
  </style>
  <template>
    <template is="dom-repeat" items="{{filters}}">
      <div index="{{index}}">
        <template is="dom-repeat" items="{{item}}" class="filter">
          <paper-button raised="{{!item.filtered}}" on-tap="setFilter" title="{{item.name}}">
            <span>{{item.name}}</span>
            <template is="dom-if" if="{{showNumbers}}">
              <span class="mini-badge">{{item.num}}</span>
            </template>
          </paper-button>
        </template>
      </div>
    </template>
  </template>
</dom-module>
<script>
(function() {
  function hasTypes (data,types) {
    for (var key in types) {
      if (types.hasOwnProperty(key)) {
        var obj = types[key];
        for (var prop in obj) {
          if(obj.hasOwnProperty(prop)){
            if (data.hasOwnProperty(key)) {
              if (obj[prop]) {
                if (data[key].indexOf(prop) === -1 ) {
                  return false;
                }
              } else {
                if (data[key].indexOf(prop) !== -1 ) {
                  return false;
                }
              }
            } else {
              return false;
            }
          }
        }
      }
    }
    return true;
  }
  function isEmpty(obj) {
    for(var prop in obj) {
      if(obj.hasOwnProperty(prop)) {
        return false;
      }
    }
    return true;
  }
  Polymer({
    is: 'paper-filter',
    properties:{
      filters:{
        computed: 'getFilters(data,byArray,obj_filters)'
      },
      top_filter:{
        type: Array,
        notify: true,
        computed: 'justProperties(data, byArray[0], 0, 0, obj_filters)'
      },
      obj_filters:{
        type: Object,
        notify: true
      },
      by:String,
      byArray:{
        computed: 'getByArray(by)'
      },
      output:{
        notify: true,
        computed: 'justOfTypes(data,obj_filters)'
      },
      data:Array,
      dataGrid:{
        type:Object,
        computed: 'getDataGrid(data,byArray)'
      },
      max:Array,
      numberPressed:{type:Array,value:[]},
      observers: ["render(obj_filters.*)"]
    },
    getDataGrid: function(data,byArray) {
      for (var i = 0,l = byArray.length; i < l; i++) {
        var by = byArray;
        var list = [];
        var filters = this.getFilters(data,byArray,{});
        debugger;
        for (var index = 0,length = filters.length; index < l; index++) {
          var filter = filters[index];
          debugger;
          list.pull(justOfTypes(data,filter))
        }
        // list.sort closist to data.length / 2 at top
        
        for (var index = 0,length = list.length; index < l; index++) {
          //make data grid
          debugger;
        }

      }
    },
    getByArray: function(by) {
      return by.split(',');
    },
    justProperties: function(data, properties, numberPressed, index, obj_filters) {
      var output = [];
      var outputNum = [];
      var max = 0;
      if (data !== undefined && data !== null && Array.isArray(data) && data.length > 1) {// garding
        var _obj_filters = {};
        if (index  > 0) { // perform the filters that come before
          for (var i = 0,l = index; i < l; i++) {
            if (obj_filters.hasOwnProperty(properties)) {
              _obj_filters[properties] = obj_filters[properties];
            }
          }
          data = this.justOfTypes(data, _obj_filters);
        }
        var test = function(entryA) {
          if (output.indexOf(entryA) === -1) {
            output.push(entryA);
            outputNum.push(1);
          } else {
            outputNum[output.indexOf(entryA)]++;
          }
        };
        for (var i = 0, l = data.length; i < l; i++) {
          if (data[i][properties] === undefined) continue;
          if (Array.isArray(data[i][properties])) {
            for (var b = 0, c = data[i][properties].length; b < c; b++) {
              test(data[i][properties][b]);
            }
            if (max < c) { max = c; }
          } else {
            test(data[i][properties]);
            max = 1
          }
        }
      }
      var result = [];
      for (var a = 0, x = output.length; a < x; a++) {
        result[a] = {
          name: output[a],
          num: outputNum[a],
          filtered: this.ifFiltered(output[a], properties, numberPressed)
        };
      }

      function closistTo(numb) {
        return function(a, b) {
          return ((numb-a.num)^2) - ((numb-b.num)^2);
        }
      }

      result.sort(closistTo(output.length/2));
      
      return {value :result, max: max};
    },
    ifFiltered: function(name, properties, numberPressed) {
      if (numberPressed == 0) {
        return false;
      }
      if (this.obj_filters.hasOwnProperty(properties)) {
        if (this.obj_filters[properties].hasOwnProperty(name)) {
          return this.obj_filters[properties][name];
        } else {
          return false;
        }
      } else {
        return false;
      }
    },
    justOfTypes: function(data, obj_filters){ 
      if (obj_filters.hasOwnProperty('base') && obj_filters.hasOwnProperty('path') && obj_filters.hasOwnProperty('value')) {
        obj_filters = obj_filters.value;
      }

      if (data === null || data === undefined) {
        return [];
      }
      if (this.totalPressed == 0) return data
      if (obj_filters === undefined || isEmpty(obj_filters)) { // no filtering needed
        return data;
      } else {
        var output = [];
        for (var entry = 0, l = data.length; entry < l; entry++) {
          if (hasTypes(data[entry],obj_filters)) { // This is the filter
            output.push(data[entry]); 
          }
        };
        return output;
      }
    },
    setFilter: function(e) {
      var title = e.currentTarget.getAttribute('title');
      var index = +e.currentTarget.parentElement.index;
      var by = this.byArray[index];
      var max = +this.max[index];
      if (this.obj_filters.hasOwnProperty(by)) {
        if (this.obj_filters[by].hasOwnProperty(title)) {
          delete this.obj_filters[by][title];
          if (isEmpty(this.obj_filters[by])) {
            delete this.obj_filters[by];
            this.numberPressed[index]--
          }
        } else {
          if (max === this.numberPressed[index]) {
            this.obj_filters[by] = {};
            this.numberPressed[index] = max;
          } else {
            this.numberPressed[index]++
          }
          this.obj_filters[by][title] = true;
        }
      } else {
        if (this.obj_filters === undefined) {
          this.obj_filters = {};
        }
        this.obj_filters[by] = {};
        this.obj_filters[by][title] = true;
        this.numberPressed[index]++
      }
      this.render();
    },
    getFilters: function (data, byArray, obj_filters) {
      var a = [];
      var max = [];
      var numberPressed = [];
      var output = data;
      
      for (var i = 0,l = byArray.length; i < l; i++) {
        var filter = this.justProperties(output, byArray[i], numberPressed[i], i, obj_filters);
        a.push(filter.value);
        max.push(filter.max);// side affect
        numberPressed.push(0);// side affect
      }
      if (this.max !== max) {this.max = max}; 
      if (this.numberPressed.length === 0) { this.numberPressed = numberPressed; }
      //TODO clear not showing filters
      this.render();
      return a; 
    },
    render: function (o) {
      var f = document.querySelectorAll('template.filter'); 
      for (var i = 0, l = f.length; i < l; i++) {
        f[i].render()
      };
    }
  });
})();
</script>
