<link rel="import" href="../paper-button/paper-button.html">

<dom-module id='paper-filter'> 
  <style>
  :host {
    max-height: 142px;
    display: block;
    overflow: hidden;
  }
  paper-button {
    background: #fff;
    min-width: 172px;
    margin: 0px 2px 6px;
  }
  paper-button {
    background: var(--accent-color);
  }
  paper-button[raised] {
    background: #fff !important;
  }
  :host div+div paper-button {
    font-size: .9em;
    min-width:106px;
  }
  .mini-badge {
    display: inline-block;
    min-width: 10px;
    padding: 3px 7px;
    color: #FFF;
    vertical-align: baseline;   
    background-color: #6F6F6F;
    border-radius: 10px;
  }
  </style>
  <template>
    <template is="dom-repeat" items="{{filters}}">
      <div index="{{index}}">
        <template is="dom-repeat" items="{{item}}">
          <paper-button raised="{{!item.filtered}}" on-tap="setFilter" title="{{item.name}}">
            <span>{{item.name}}</span>
            <template is="dom-if" if="{{showNumbers}}">
              <span class="mini-badge">{{item.num}}</span>
            </template>
          </paper-button>
        </template>
      </div>
    </template>
  </template>
</dom-module>
<script>
(function() {
  function hasTypes (data,types) {
    for (var key in types) {
      if (types.hasOwnProperty(key)) {
        var obj = types[key];
        for (var prop in obj) {
          if(obj.hasOwnProperty(prop)){
            if (data.hasOwnProperty(key)) {
              if (obj[prop]) {
                if (data[key].indexOf(prop) === -1 ) {
                  return false;
                }
              } else {
                if (data[key].indexOf(prop) !== -1 ) {
                  return false;
                }
              }
            } else {
              return false;
            }
          }
        }
      }
    }
    return true;
  }
  function isEmpty(obj) {
    for(var prop in obj) {
      if(obj.hasOwnProperty(prop)) {
        return false;
      }
    }
    return true;
  }
  Polymer({
    is: 'paper-filter',
    properties: {
      filters: {
        computed: "getFilters"
      },
      top_filter: {
        type: Array,
        notify: true
      },
      obj_filters: {
        type: Object,
        notify: true //,
        // observer: "render"
      },
      by: String,
      output: {
        notify: true,
        computed: "justOfTypes(data,obj_filters)"
      },
      data: Array,
      max: Array,
      numberPressed: Array,
      totalPressed: {
        computed: 'getTotalPressed(numberPressed)'
      }
    },
    getTotalPressed: function(numberPressed) {
      var total = 0;
      for (var pressed in numberPressed) {
        total = pressed + total;
      }
      return total;
    },
    justProperties: function(data, index) {
      var properties = this.by.split(',')[index];
      var numberPressed = 0
      if (this.numberPressed.length >= index) {
        numberPressed = this.numberPressed[index];
      }
      var output = [];
      var outputNum = [];
      var max = 0;
      if (data !== undefined && data !== null && Array.isArray(data) && data.length > 1) {
        var obj_filters = {}
        if (index  > 0) {
          for (var i = 0,l = index; i < l; i++) {
            if (this.obj_filters.hasOwnProperty(this.by.split(',')[i])) {
              obj_filters[this.by.split(',')[i]] = this.obj_filters[this.by.split(',')[i]];
            }
          }
          data = this.justOfTypes(data,obj_filters);
        }
        var test = function(entryA) {
          if (output.indexOf(entryA) === -1) {
            output.push(entryA);
            outputNum.push(1);
          } else {
            outputNum[output.indexOf(entryA)]++;
          }
        };
        for (var i = 0, l = data.length; i < l; i++) {
          if (data[i][properties] === undefined) continue;
          if (Array.isArray(data[i][properties])) {
            for (var b = 0, c = data[i][properties].length; b < c; b++) {
              test(data[i][properties][b]);
            }
            if (max < c) { max = c; }
          } else {
            test(data[i][properties]);
            max = 1
          }
        }
      }
      var result = [];
      for (var a = 0, x = output.length; a < x; a++) {
        result[a] = {
          name: output[a],
          num: outputNum[a],
          filtered: this.ifFiltered(output[a], properties, numberPressed)
        };
      }
      result.sort(function(a, b) {
        return b.num - a.num;
      });
      
      return {value :result, max: max};
    },
    ifFiltered: function(name, properties, numberPressed) {
      if (numberPressed == 0) {
        return false;
      }
      if (this.obj_filters.hasOwnProperty(properties)) {
        if (this.obj_filters[properties].hasOwnProperty(name)) {
          return this.obj_filters[properties][name];
        } else {
          return false;
        }
      } else {
        return false;
      }
    },
    justOfTypes: function(data, obj_filters){ 
      if (data === null || data === undefined) {
        return [];
      }
      if (this.totalPressed == 0) return data
      if (obj_filters === undefined || isEmpty(obj_filters)) { // no filtering needed
        return data;
      } else {
        var output = [];
        for (var entry = 0, l = data.length; entry < l; entry++) {
          if (hasTypes(data[entry],obj_filters)) { // This is the filter
            output.push(data[entry]); 
          }
        };
        return output;
      }
    },
    setAllFilters: function() {
      if (this.by !== undefined) {
        var index = 0
        var byArray = this.by.split(',');
        for (var by in this.obj_filters) {
          index = byArray.indexOf(by);
          if (this.obj_filters.hasOwnProperty(by)) {
            var obj = this.obj_filters[by];
            for (var title in obj) {
              if(obj.hasOwnProperty(title)){
                if (obj[title] === true) {
                  this._setFilter(title,by,20,index); // max set to 20
                }
              }
            }
          }
        }
      }
    },
    setFilter: function(e) {
      var title  = e.currentTarget.getAttribute('title');
      var index = +e.currentTarget.parentElement.index;
      var by = this.by.split(',')[index];
      var max = +this.max[index];
      this._setFilter(title,by,max,index)
    },
    _setFilter: function(title,by,max,index) {
      if (this.obj_filters.hasOwnProperty(by)) {
        if (this.obj_filters[by].hasOwnProperty(title)) {
          delete this.obj_filters[by][title];
          if (isEmpty(this.obj_filters[by])) {
            delete this.obj_filters[by];
            this.numberPressed[index]--
          }
        } else {
          if (max === this.numberPressed[index]) {
            this.obj_filters[by] = {};
            this.numberPressed[index] = max;
          } else {
            this.numberPressed[index]++
          }
          this.obj_filters[by][title] = true;
        }
      } else {
        if (this.obj_filters === undefined) {
          this.obj_filters = {};
        }
        this.obj_filters[by] = {};
        this.obj_filters[by][title] = true;
        this.numberPressed[index]++
      }
    },
    getFilters: function () {
      var a = [];
      var max = [];
      var numberPressed = [];
      var output = this.data;
      
      for (var i = 0,l = this.by.split(',').length; i < l; i++) {
        var by = this.by.split(',')[i];
        var filter = this.justProperties(output,i)
        if (i === 0) { 
          this.top_filter = filter.value;
        }
        a.push(filter.value);
        max.push(filter.max);
        numberPressed.push(0);
      }
      if (this.max != max) { this.max = max; }
      if (this.numberPressed.length === 0) { this.numberPressed = numberPressed; }
      //TODO clear not showing filters
      return a;
    },
    numberPressed: []
  });
})();
</script>
